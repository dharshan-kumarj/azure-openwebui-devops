- name: Configure VM and deploy OpenWebUI (persistent)
  hosts: openwebui
  become: yes

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install base packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Install Docker
      shell: |
        curl -fsSL https://get.docker.com | sh
      args:
        creates: /usr/bin/docker

    - name: Enable and start Docker
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Create OpenWebUI data directory
      file:
        path: /opt/openwebui-data
        state: directory
        owner: azureuser
        group: azureuser
        mode: '0755'

    - name: Copy OpenWebUI env file
      copy:
        src: .env
        dest: /home/azureuser/openwebui.env
        owner: azureuser
        group: azureuser
        mode: '0600'

    - name: Remove existing OpenWebUI container if present
      shell: |
        docker rm -f openwebui || true

    - name: Run OpenWebUI container with persistent volume
      shell: |
        docker run -d \
          --name openwebui \
          --restart always \
          -p 3000:8080 \
          -v /opt/openwebui-data:/app/backend/data \
          --env-file /home/azureuser/openwebui.env \
          ghcr.io/open-webui/open-webui:latest
